sudo: required

services:
  - docker

matrix:
  include:
    # landlordd (daemon)
    - language: scala
      cache:
        directories:
          - $HOME/.ivy2/cache
          - $HOME/.sbt/launchers
      before_cache:
        # Ensure changes to the cache aren't persisted
        - rm -rf $HOME/.ivy2/cache/com/github/huntc/landlord
        # Delete all ivydata files since ivy touches them on each build
        - find $HOME/.ivy2/cache -name "ivydata-*.properties" | xargs rm
      before_script:
        - cd landlordd
        - unset _JAVA_OPTIONS

    # landlord (CLI)
    - language: rust
      before_script:
        - cd landlord

    # integration test (landlordd <--> landlord)
    - language: scala
      cache:
        directories:
          - $HOME/.ivy2/cache
          - $HOME/.sbt/launchers
      before_cache:
        # Ensure changes to the cache aren't persisted
        - rm -rf $HOME/.ivy2/cache/com/github/huntc/landlord
        # Delete all ivydata files since ivy touches them on each build
        - find $HOME/.ivy2/cache -name "ivydata-*.properties" | xargs rm
      install:
        - curl https://sh.rustup.rs/ | sh -s -- -y
      before_script:
        - unset _JAVA_OPTIONS
        - export PATH="$HOME/.cargo/bin:$PATH"
      script:
        - scripts/integration-test-cli

    # Publish to DockerHub (if branch begins with v)
    - language: scala
      cache:
        directories:
          - $HOME/.ivy2/cache
          - $HOME/.sbt/launchers
      before_cache:
        # Ensure changes to the cache aren't persisted
        - rm -rf $HOME/.ivy2/cache/com/github/huntc/landlord
        # Delete all ivydata files since ivy touches them on each build
        - find $HOME/.ivy2/cache -name "ivydata-*.properties" | xargs rm
      install:
        - "{ git describe --abbrev=0 --tags | grep ^v; } &>/dev/null && { curl https://sh.rustup.rs/ | sh -s -- -y; } || true"
      before_script:
        - unset _JAVA_OPTIONS
        - export PATH="$HOME/.cargo/bin:$PATH"
      script:
        - "{ git describe --abbrev=0 --tags | grep ^v; } &>/dev/null && scripts/release-dockerhub || true"
env:
  global:
  - secure: hvBfA+nR0Utzlq4GzELBBaJkxrJDVVl2rzUrL81Vyn9ORz9B6N9DF4ZxAUyxOMRqPWPFI/I7k7F116n5f+oRIM2kLeQwk2dZme5gmcPN4e+6tMKIzXHj8cJBmxMX3FhbffpFL3CzVL0Yp6SDdjUsVNN9jdxmsXW4PBEZTjWLaKEPF60rMXDlsznt1k8bcbgjMuIsS8w+BO36nrbvwju6L+yw55SkVacIqBlnwk5ENbCiQrsS5i7Imxn3f5wPOZIouFqDaK5sviXdUT/6tGThOMmToYJWtcSS5C91Ljg7SW0rrf9527IypAtRFzlEFYX0wvKHv3PSJSJjlZYzKEjSE70ieFBF0ko4oy7v3VEAA0U3ZOYpUslwzYt3cfilvDmLSbKH9F2KCuJHAYTwYFu1qHCyNL+zWRI91LUJhvSI2xhAQN4PJd+T2dtgPcrwfWvRD2bx0A9UY/U+Kd8maOW//3DIcDHrDel/txbNEUk/PBR5PX3UXdfXgNm5P5yCo1V3w01a6p/xy3Ont5NJLEFAOLVNxZ3exUJqVukYb/gG7Wx3pdRibwk0A9GcYo0kV71SXIs1u4orKHE5Toj/hM3meqSj40AFI8WGLJIqwCBx+23mUND/Sq1pxHc3lB+M3BatCQwsKmd2r5p7YFytSOWi98X4y2L6bVLsIVPwiFQSYZk=
  - secure: SkFVs+h0p0I1Tlg9HJnyjHNJcGcsv4ggBBFpmYTr3vReKSOqwGHJ9OBn224ReKZ+mmusXnTiDnRpUfCSt266wlGFe5lQ9DRWAy0eQUUVB7e1sN1UBIjBhi5ndKblAfxFiKgOeKu8qvyYDMjLsNNN/NcvaGRs8wubh9uZmFQMprPJ6ehpF2IggDgFVuE2xeLvADDi3Ls3Cs52+KS+rOo+JPfAbASkYfqdtV/lOoRsR9t63GV3YyT7jnSvLDT/utv92AHGGmhMlsY/0ov4dY8HWQaRb6Xo0wqFBL5ZrYcwWlOwvEo3zbetkYWi1mSppKgWME7Pr5+htYWclKHL5cKSbmwsblN0p/GRiXpSQ2vcFYjOMhKsfhg1C9DhRQueKy3QC4qwedatmOud6RV0gNnJ6SkJ9P2N4obUkDWejWb+MICgDKAVrCw7MO59ILlMUDOla6x6MK9VTEzTNARyDTYMuqB4USQeblekgbCSKpm0BXNprIutaRvGmGdgAole7dK5+3CqkdacvE74EdJ3POEe+hWipcOp7EmvYC+AHhCxKcm98c37r2C7Go9ETIUrMHp/ow+QwQMfMJkgFECwKczS+vTghDtOwCp1cFfMg1lqa/7PQoGl4egKj78Qh0LxZB5GYj429Z737sRTTtJQpJCXE5O3QAQ3L7IJEhGNBpJrEQU=
